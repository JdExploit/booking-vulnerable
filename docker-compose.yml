version: '3.8'

services:
  # Servidor Web Principal (Vulnerable)
  web:
    build: 
      context: .
      dockerfile: Dockerfile.web
    container_name: crypto_nexus_web
    hostname: cryptonexus-web
    restart: unless-stopped
    ports:
      - "8080:80"
      - "2222:22"  # SSH expuesto intencionalmente
    volumes:
      - ./src:/var/www/html
      - ./uploads:/var/www/html/uploads
      - ./logs:/var/log/apache2
      - ./ssh_keys:/root/.ssh:ro
      - ./vulnerable_scripts:/opt/scripts
    environment:
      - APP_ENV=development
      - DEBUG=true
      - AWS_METADATA_URL=http://169.254.169.254
      - DB_HOST=mysql_internal
      - DB_ROOT_PASSWORD=SuperInsecureRoot123!
      - JWT_SECRET=very_weak_secret_change_me
      - ADMIN_API_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.admin
      - FLAG_1=CTF{SSRF_to_Metadata}
      - FLAG_2=CTF{SQLi_to_RCE}
      - FLAG_3=CTF{File_Upload_to_Reverse_Shell}
    networks:
      - frontend_network
      - backend_network
      - internal_network
    cap_add:
      - SYS_PTRACE  # Para debugging pero vulnerable
    privileged: false
    depends_on:
      - mysql_internal
      - redis
      - vulnerable_api
    labels:
      - "vulnerability.level=critical"
      - "pentest.target=true"

  # API Vulnerable Interna
  vulnerable_api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: crypto_api
    hostname: crypto-api.internal
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - ./api:/app
      - ./secrets:/app/secrets:ro
    environment:
      - NODE_ENV=development
      - DB_HOST=mysql_internal
      - REDIS_HOST=redis
      - SECRET_KEY=insecure_secret_123
      - AWS_ACCESS_KEY=AKIAIOSFODNN7EXAMPLE
      - FLAG_4=CTF{Prototype_Pollution_RCE}
    networks:
      - backend_network
      - internal_network
    depends_on:
      - mysql_internal
      - redis

  # MySQL con datos sensibles
  mysql_internal:
    image: mysql:8.0
    container_name: crypto_mysql
    hostname: mysql.internal
    restart: unless-stopped
    ports:
      - "3306:3306"  # Expuesto intencionalmente
    environment:
      MYSQL_ROOT_PASSWORD: RootPassword123!
      MYSQL_DATABASE: crypto_nexus
      MYSQL_USER: crypto_user
      MYSQL_PASSWORD: CryptoPass123!
    volumes:
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
      - ./database/backup.sql:/backup/backup.sql
      - mysql_data:/var/lib/mysql
    networks:
      - backend_network
      - internal_network
    command: 
      - --default-authentication-plugin=mysql_native_password
      - --secure-file-priv=/tmp
      - --local-infile=1  # Vulnerabilidad habilitada

  # Redis con datos en memoria
  redis:
    image: redis:7-alpine
    container_name: crypto_redis
    hostname: redis.internal
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --requirepass weakpassword123
    volumes:
      - redis_data:/data
    networks:
      - backend_network
      - internal_network

  # Servidor FTP Vulnerable
  ftp:
    image: stilliard/pure-ftpd
    container_name: crypto_ftp
    hostname: ftp.internal
    restart: unless-stopped
    ports:
      - "21:21"
      - "30000-30009:30000-30009"
    environment:
      FTP_USER_NAME: admin
      FTP_USER_PASS: admin
      FTP_USER_HOME: /home/admin
      PUBLICHOST: localhost
    volumes:
      - ./ftp_data:/home/admin
      - ./ftp_config:/etc/pure-ftpd
    networks:
      - internal_network

  # MinIO (S3 Vulnerable)
  minio:
    image: minio/minio
    container_name: crypto_minio
    hostname: minio.internal
    restart: unless-stopped
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
      MINIO_BROWSER_REDIRECT_URL: http://localhost:9001
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    networks:
      - internal_network

  # ElasticSearch vulnerable a RCE
  elasticsearch:
    image: elasticsearch:7.10.2
    container_name: crypto_elastic
    hostname: elastic.internal
    restart: unless-stopped
    ports:
      - "9200:9200"
      - "9300:9300"
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    volumes:
      - elastic_data:/usr/share/elasticsearch/data
    networks:
      - internal_network

  # Metabase para dashboards (vulnerable)
  metabase:
    image: metabase/metabase
    container_name: crypto_metabase
    hostname: metabase.internal
    restart: unless-stopped
    ports:
      - "3001:3000"
    environment:
      - MB_DB_TYPE=postgres
      - MB_DB_DBNAME=metabase
      - MB_DB_PORT=5432
      - MB_DB_USER=metabase
      - MB_DB_PASS=metabase123
    networks:
      - internal_network

  # Jenkins CI/CD vulnerable
  jenkins:
    image: jenkins/jenkins:lts
    container_name: crypto_jenkins
    hostname: jenkins.internal
    restart: unless-stopped
    ports:
      - "8081:8080"
      - "50000:50000"
    volumes:
      - jenkins_data:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock  # ¡PELIGROSO!
    environment:
      - JAVA_OPTS=-Djenkins.install.runSetupWizard=false
    user: root  # ¡VULNERABLE!
    networks:
      - internal_network

  # PostgreSQL con datos financieros
  postgres:
    image: postgres:14
    container_name: crypto_postgres
    hostname: postgres.internal
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: financial_data
      POSTGRES_USER: crypto_admin
      POSTGRES_PASSWORD: AdminPassword123!
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/seed.sql:/docker-entrypoint-initdb.d/seed.sql
    networks:
      - internal_network

  # Servidor de Monitoreo (expuesto)
  monitoring:
    image: prom/prometheus
    container_name: crypto_monitoring
    hostname: monitoring.internal
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    networks:
      - internal_network

  # Grafana con dashboards
  grafana:
    image: grafana/grafana
    container_name: crypto_grafana
    hostname: grafana.internal
    restart: unless-stopped
    ports:
      - "3002:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin123
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - internal_network

networks:
  frontend_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
  backend_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/24
  internal_network:
    driver: bridge
    internal: true  # Red interna, no accesible directamente
    ipam:
      config:
        - subnet: 10.10.0.0/24

volumes:
  mysql_data:
  redis_data:
  minio_data:
  elastic_data:
  jenkins_data:
  postgres_data:
  prometheus_data:
  grafana_data:
